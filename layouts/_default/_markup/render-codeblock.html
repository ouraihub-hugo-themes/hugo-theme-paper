{{- /*
  Render Hook for Code Blocks
  
  This template handles code block rendering with support for two modes:
  1. Basic mode: Uses Hugo's built-in Chroma highlighter
  2. Shiki mode: Uses pre-processed HTML from Shiki
  
  The mode is determined by the codeHighlight.engine parameter in params.toml
  
  Requirements: 1.1, 1.4, 8.1, 8.2
*/ -}}

{{- /* Get configuration */ -}}
{{- $engine := .Page.Site.Params.codeHighlight.engine | default "basic" -}}
{{- $lang := .Type -}}
{{- $code := .Inner -}}
{{- $attributes := .Attributes -}}

{{- /* Debug information (only in development) */ -}}
{{- if hugo.IsServer -}}
  {{- /* warnf "Code block: lang=%s, engine=%s, attributes=%#v" $lang $engine $attributes */ -}}
{{- end -}}

{{- if eq $engine "shiki" -}}
  {{- /* Shiki mode: Try to read pre-processed HTML */ -}}
  
  {{- /* Generate cache file path based on page and code block position */ -}}
  {{- $pageID := "" -}}
  {{- with .Page.File -}}
    {{- $pageID = .UniqueID -}}
  {{- else -}}
    {{- /* For pages without File (e.g., taxonomy pages), use RelPermalink hash */ -}}
    {{- $pageID = .Page.RelPermalink | md5 -}}
  {{- end -}}
  
  {{- $ordinal := .Ordinal -}}
  {{- $shikiFile := printf "shiki-cache/%s-%d.html" $pageID $ordinal -}}
  
  {{- /* Try to read the Shiki-processed HTML from resources */ -}}
  {{- $shikiHTML := "" -}}
  {{- $shikiResource := resources.Get $shikiFile -}}
  {{- if $shikiResource -}}
    {{- $shikiHTML = $shikiResource.Content -}}
  {{- end -}}
  
  {{- if $shikiHTML -}}
    {{- /* Successfully loaded Shiki HTML */ -}}
    {{- $shikiHTML | safeHTML -}}
  {{- else -}}
    {{- /* Fallback to basic mode if Shiki HTML not found */ -}}
    {{- if hugo.IsServer -}}
      {{- $pagePath := "" -}}
      {{- with .Page.File -}}
        {{- $pagePath = .Path -}}
      {{- else -}}
        {{- $pagePath = .Page.RelPermalink -}}
      {{- end -}}
      {{- warnf "Shiki HTML not found at %s for page %s (block %d), falling back to basic mode" $shikiFile $pagePath $ordinal -}}
    {{- end -}}
    {{- partial "code-block-basic.html" (dict "code" $code "lang" $lang "attributes" $attributes "page" .Page) -}}
  {{- end -}}
  
{{- else -}}
  {{- /* Basic mode: Use Chroma + client-side enhancement */ -}}
  {{- partial "code-block-basic.html" (dict "code" $code "lang" $lang "attributes" $attributes "page" .Page) -}}
{{- end -}}
