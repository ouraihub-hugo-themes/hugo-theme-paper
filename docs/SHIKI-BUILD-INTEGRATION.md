# Shiki æ„å»ºæµç¨‹é›†æˆ

æœ¬æ–‡æ¡£æè¿°äº† Shiki ä»£ç é«˜äº®çš„æ„å»ºæµç¨‹é›†æˆã€‚

## æ¦‚è¿°

Shiki æ„å»ºæµç¨‹å·²å®Œå…¨é›†æˆåˆ°é¡¹ç›®çš„æ„å»ºç³»ç»Ÿä¸­ï¼Œæ”¯æŒï¼š

- âœ… å¢é‡æ„å»ºï¼ˆåªå¤„ç†ä¿®æ”¹è¿‡çš„æ–‡ä»¶ï¼‰
- âœ… å¹¶è¡Œå¤„ç†ï¼ˆæé«˜æ„å»ºé€Ÿåº¦ï¼‰
- âœ… è¿›åº¦æ˜¾ç¤ºï¼ˆå®æ—¶æ˜¾ç¤ºå¤„ç†è¿›åº¦ï¼‰
- âœ… ç¼“å­˜ç³»ç»Ÿï¼ˆé¿å…é‡å¤å¤„ç†ï¼‰
- âœ… é”™è¯¯å¤„ç†ï¼ˆä¼˜é›…åœ°å¤„ç†é”™è¯¯ï¼‰

## å¯ç”¨å‘½ä»¤

### åŸºç¡€å‘½ä»¤

```bash
# å¤„ç†æ‰€æœ‰ Markdown æ–‡ä»¶ä¸­çš„ä»£ç å—
pnpm shiki:process

# æ¸…ç† Shiki ç¼“å­˜å’Œè¾“å‡º
pnpm shiki:clean

# å®Œæ•´çš„ Shiki æ„å»ºï¼ˆåŒ…å« Hugo æ„å»ºï¼‰
pnpm build:shiki
```

### å¼€å‘å‘½ä»¤

```bash
# å¯åŠ¨ Shiki ç›‘å¬æ¨¡å¼ï¼ˆè‡ªåŠ¨é‡æ–°å¤„ç†ä¿®æ”¹çš„æ–‡ä»¶ï¼‰
pnpm dev:shiki

# æˆ–è€…ä½¿ç”¨æ ‡å‡†å¼€å‘æ¨¡å¼ï¼ˆä¸åŒ…å« Shikiï¼‰
pnpm dev
```

## æ„å»ºæµç¨‹

### 1. Shiki å¤„ç†æµç¨‹

```
Markdown æ–‡ä»¶ â†’ æ‰«æä»£ç å— â†’ Shiki å¤„ç† â†’ ç”Ÿæˆ HTML â†’ ç¼“å­˜ â†’ è¾“å‡º JSON
```

### 2. å®Œæ•´æ„å»ºæµç¨‹

```bash
pnpm build:shiki
```

æ‰§è¡Œæ­¥éª¤ï¼š
1. ç¼–è¯‘ TypeScript (`pnpm ts:build`)
2. ç¼–è¯‘ CSS (`pnpm css:build`)
3. å¤„ç† Shiki (`pnpm shiki:process`)
4. æ„å»º Hugo (`hugo --gc`)
5. ç”Ÿæˆæœç´¢ç´¢å¼• (`pnpm pagefind`)

### 3. å¼€å‘æµç¨‹ï¼ˆå¸¦ Shikiï¼‰

```bash
pnpm dev:shiki
```

å¹¶è¡Œè¿è¡Œï¼š
1. TypeScript ç›‘å¬ (`pnpm ts:watch`)
2. CSS ç›‘å¬ (`pnpm css:watch`)
3. Shiki ç›‘å¬ (`pnpm shiki:watch`)
4. Hugo æœåŠ¡å™¨ (`hugo server`)

## å¢é‡æ„å»º

### å·¥ä½œåŸç†

å¢é‡æ„å»ºé€šè¿‡ä»¥ä¸‹æ–¹å¼æé«˜æ„å»ºé€Ÿåº¦ï¼š

1. **æ„å»ºæ—¶é—´è®°å½•**ï¼šæ¯æ¬¡æ„å»ºåä¿å­˜æ—¶é—´æˆ³åˆ° `.shiki-cache/build-time.json`
2. **æ–‡ä»¶ä¿®æ”¹æ£€æµ‹**ï¼šæ¯”è¾ƒæ–‡ä»¶çš„ä¿®æ”¹æ—¶é—´ä¸ä¸Šæ¬¡æ„å»ºæ—¶é—´
3. **é€‰æ‹©æ€§å¤„ç†**ï¼šåªå¤„ç†ä¿®æ”¹è¿‡çš„æ–‡ä»¶

### é…ç½®é€‰é¡¹

```typescript
const build = new ShikiBuild({
  incremental: true,  // å¯ç”¨å¢é‡æ„å»ºï¼ˆé»˜è®¤ï¼‰
  parallel: true,     // å¯ç”¨å¹¶è¡Œå¤„ç†ï¼ˆé»˜è®¤ï¼‰
  verbose: false,     // è¯¦ç»†æ—¥å¿—ï¼ˆé»˜è®¤å…³é—­ï¼‰
});
```

### ç¦ç”¨å¢é‡æ„å»º

å¦‚æœéœ€è¦å¼ºåˆ¶é‡æ–°å¤„ç†æ‰€æœ‰æ–‡ä»¶ï¼š

```bash
# æ–¹æ³• 1: æ¸…ç†ç¼“å­˜åé‡æ–°æ„å»º
pnpm shiki:clean
pnpm shiki:process

# æ–¹æ³• 2: ä½¿ç”¨ --no-incremental æ ‡å¿—ï¼ˆéœ€è¦åœ¨è„šæœ¬ä¸­å®ç°ï¼‰
node bin/shiki-build.js --no-incremental
```

## è¿›åº¦æ˜¾ç¤º

### è¾“å‡ºæ ¼å¼

```
[Shiki] Starting build...
[Shiki] Initializing Shiki build...
[Shiki] Initialization complete
[Shiki] Incremental build enabled (last build: 2025-11-13T01:49:53.214Z)
[Shiki] Scanning markdown files...
[Shiki] Found 5 files with 10 code blocks

â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
Processing files...
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

[Shiki] ğŸ“„ Processing post/example.md (3 blocks)
[Shiki] âœ“ Completed post/example.md: 3 success, 0 failed (45ms)

[â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆ] 100.0% (5/5)
Processed: 10, Cached: 0, Failed: 0

â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

============================================================
Shiki Build Complete
============================================================
Total files:       5
Skipped files:     0
Total blocks:      10
Processed blocks:  10
Cached blocks:     0
Failed blocks:     0
Duration:          0.15s
Avg time/block:    15.00ms
Skip rate:         0.0% (incremental build)
============================================================
```

### è¿›åº¦æŒ‡ç¤ºå™¨

- ğŸ“„ æ­£åœ¨å¤„ç†æ–‡ä»¶
- âœ“ å¤„ç†æˆåŠŸ
- âœ— å¤„ç†å¤±è´¥
- âŠ˜ è·³è¿‡æœªä¿®æ”¹çš„æ–‡ä»¶
- [â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–‘â–‘] è¿›åº¦æ¡

## æ€§èƒ½ä¼˜åŒ–

### 1. ç¼“å­˜ç³»ç»Ÿ

Shiki ä½¿ç”¨ä¸¤çº§ç¼“å­˜ï¼š

1. **å†…å­˜ç¼“å­˜**ï¼šå¤„ç†è¿‡çš„ä»£ç å—ä¿å­˜åœ¨å†…å­˜ä¸­
2. **ç£ç›˜ç¼“å­˜**ï¼šä¿å­˜åˆ° `.shiki-cache/` ç›®å½•

ç¼“å­˜é”®åŸºäºï¼š
- ä»£ç å†…å®¹
- è¯­è¨€
- Meta ä¿¡æ¯ï¼ˆæ–‡ä»¶åã€diff æ ‡è®°ç­‰ï¼‰

### 2. å¹¶è¡Œå¤„ç†

é»˜è®¤å¯ç”¨å¹¶è¡Œå¤„ç†ï¼Œå¯ä»¥åŒæ—¶å¤„ç†å¤šä¸ªä»£ç å—ï¼š

```typescript
// å¹¶è¡Œå¤„ç†ï¼ˆé»˜è®¤ï¼‰
parallel: true,
concurrency: 4,  // å¹¶å‘æ•°

// ä¸²è¡Œå¤„ç†ï¼ˆè°ƒè¯•æ—¶ä½¿ç”¨ï¼‰
parallel: false,
```

### 3. å¢é‡æ„å»º

åªå¤„ç†ä¿®æ”¹è¿‡çš„æ–‡ä»¶ï¼Œå¤§å¹…å‡å°‘æ„å»ºæ—¶é—´ï¼š

```
é¦–æ¬¡æ„å»º: 100 ä¸ªæ–‡ä»¶ï¼Œè€—æ—¶ 10s
å¢é‡æ„å»º: 5 ä¸ªä¿®æ”¹çš„æ–‡ä»¶ï¼Œè€—æ—¶ 0.5s
è·³è¿‡ç‡: 95%
```

## é”™è¯¯å¤„ç†

### 1. ä¸æ”¯æŒçš„è¯­è¨€

å½“é‡åˆ° Shiki ä¸æ”¯æŒçš„è¯­è¨€æ—¶ï¼š

```
Language "unknownlang" not supported by Shiki at content/post/example.md:10, using plaintext
```

ç³»ç»Ÿä¼šï¼š
- è®°å½•è­¦å‘Š
- å›é€€åˆ° `plaintext`
- ç»§ç»­å¤„ç†å…¶ä»–ä»£ç å—

### 2. å¤„ç†å¤±è´¥

å½“ä»£ç å—å¤„ç†å¤±è´¥æ—¶ï¼š

```
âœ— Failed to process content/post/example.md:15 (23ms): Error message
```

ç³»ç»Ÿä¼šï¼š
- è®°å½•é”™è¯¯
- å¢åŠ å¤±è´¥è®¡æ•°
- ç»§ç»­å¤„ç†å…¶ä»–ä»£ç å—
- åœ¨ç»Ÿè®¡ä¿¡æ¯ä¸­æ˜¾ç¤ºå¤±è´¥æ•°é‡

### 3. æ–‡ä»¶è®¿é—®é”™è¯¯

å½“æ— æ³•è¯»å–æ–‡ä»¶æ—¶ï¼š
- è·³è¿‡è¯¥æ–‡ä»¶
- è®°å½•è­¦å‘Š
- ç»§ç»­å¤„ç†å…¶ä»–æ–‡ä»¶

## è¾“å‡ºæ ¼å¼

### JSON è¾“å‡º

æ¯ä¸ª Markdown æ–‡ä»¶ç”Ÿæˆä¸€ä¸ªå¯¹åº”çš„ JSON æ–‡ä»¶ï¼š

```
content/post/example.md â†’ .shiki-output/post/example.json
```

JSON æ ¼å¼ï¼š

```json
[
  {
    "index": 0,
    "lang": "javascript",
    "meta": "file=example.js",
    "line": 10,
    "html": "<pre class=\"shiki\">...</pre>",
    "success": true
  },
  {
    "index": 1,
    "lang": "typescript",
    "meta": "",
    "line": 25,
    "html": "<pre class=\"shiki\">...</pre>",
    "success": true
  }
]
```

### æ„å»ºæ—¶é—´è®°å½•

`.shiki-cache/build-time.json`:

```json
{
  "lastBuildTime": 1699876193214,
  "version": "1.0.0"
}
```

## æ•…éšœæ’é™¤

### é—®é¢˜ 1: æ„å»ºå¾ˆæ…¢

**è§£å†³æ–¹æ¡ˆ**ï¼š
1. ç¡®ä¿å¯ç”¨äº†å¢é‡æ„å»º
2. ç¡®ä¿å¯ç”¨äº†å¹¶è¡Œå¤„ç†
3. æ£€æŸ¥ç¼“å­˜æ˜¯å¦æ­£å¸¸å·¥ä½œ

```bash
# æŸ¥çœ‹ç¼“å­˜ç›®å½•
ls -la .shiki-cache/

# æ¸…ç†ç¼“å­˜é‡æ–°æ„å»º
pnpm shiki:clean
pnpm shiki:process
```

### é—®é¢˜ 2: ä»£ç å—æ²¡æœ‰é«˜äº®

**å¯èƒ½åŸå› **ï¼š
1. Shiki å¤„ç†å¤±è´¥
2. è¯­è¨€ä¸æ”¯æŒ
3. ç¼“å­˜è¿‡æœŸ

**è§£å†³æ–¹æ¡ˆ**ï¼š
```bash
# æ¸…ç†ç¼“å­˜é‡æ–°å¤„ç†
pnpm shiki:clean
pnpm shiki:process --verbose
```

### é—®é¢˜ 3: å¢é‡æ„å»ºä¸å·¥ä½œ

**å¯èƒ½åŸå› **ï¼š
1. æ„å»ºæ—¶é—´è®°å½•æ–‡ä»¶æŸå
2. æ–‡ä»¶æ—¶é—´æˆ³å¼‚å¸¸

**è§£å†³æ–¹æ¡ˆ**ï¼š
```bash
# åˆ é™¤æ„å»ºæ—¶é—´è®°å½•
rm .shiki-cache/build-time.json

# é‡æ–°æ„å»º
pnpm shiki:process
```

## é…ç½®é€‰é¡¹

### å‘½ä»¤è¡Œå‚æ•°

```bash
# è¯¦ç»†æ—¥å¿—
node bin/shiki-build.js --verbose

# ç¦ç”¨å¹¶è¡Œå¤„ç†
node bin/shiki-build.js --no-parallel

# ç¦ç”¨å¢é‡æ„å»º
node bin/shiki-build.js --no-incremental

# æŒ‡å®šå†…å®¹ç›®å½•
node bin/shiki-build.js --content-dir content
```

### ç¯å¢ƒå˜é‡

```bash
# è®¾ç½®å¹¶å‘æ•°
SHIKI_CONCURRENCY=8 pnpm shiki:process

# å¯ç”¨è¯¦ç»†æ—¥å¿—
SHIKI_VERBOSE=true pnpm shiki:process
```

## æœ€ä½³å®è·µ

### 1. å¼€å‘æ—¶

```bash
# ä½¿ç”¨æ ‡å‡†å¼€å‘æ¨¡å¼ï¼ˆä¸åŒ…å« Shikiï¼Œæ›´å¿«ï¼‰
pnpm dev

# åªåœ¨éœ€è¦æµ‹è¯• Shiki åŠŸèƒ½æ—¶ä½¿ç”¨
pnpm dev:shiki
```

### 2. æ„å»ºæ—¶

```bash
# ç”Ÿäº§æ„å»ºï¼ˆåŒ…å« Shikiï¼‰
pnpm build:shiki

# æˆ–è€…åˆ†æ­¥æ„å»º
pnpm shiki:process
pnpm build
```

### 3. CI/CD

```yaml
# GitHub Actions ç¤ºä¾‹
- name: Build with Shiki
  run: |
    pnpm install
    pnpm build:shiki
```

### 4. æ€§èƒ½ä¼˜åŒ–

1. **å¯ç”¨å¢é‡æ„å»º**ï¼šå‡å°‘æ„å»ºæ—¶é—´
2. **ä½¿ç”¨ç¼“å­˜**ï¼šåœ¨ CI/CD ä¸­ç¼“å­˜ `.shiki-cache/` ç›®å½•
3. **å¹¶è¡Œå¤„ç†**ï¼šåˆ©ç”¨å¤šæ ¸ CPU

## ç»Ÿè®¡ä¿¡æ¯

æ„å»ºå®Œæˆåä¼šæ˜¾ç¤ºè¯¦ç»†çš„ç»Ÿè®¡ä¿¡æ¯ï¼š

- **Total files**: æ‰«æçš„æ–‡ä»¶æ€»æ•°
- **Skipped files**: è·³è¿‡çš„æ–‡ä»¶æ•°ï¼ˆå¢é‡æ„å»ºï¼‰
- **Total blocks**: ä»£ç å—æ€»æ•°
- **Processed blocks**: æ–°å¤„ç†çš„ä»£ç å—æ•°
- **Cached blocks**: ä»ç¼“å­˜è¯»å–çš„ä»£ç å—æ•°
- **Failed blocks**: å¤„ç†å¤±è´¥çš„ä»£ç å—æ•°
- **Duration**: æ€»è€—æ—¶
- **Avg time/block**: å¹³å‡æ¯ä¸ªä»£ç å—çš„å¤„ç†æ—¶é—´
- **Skip rate**: è·³è¿‡ç‡ï¼ˆå¢é‡æ„å»ºæ•ˆç‡ï¼‰

## ç›¸å…³æ–‡æ¡£

- [Shiki è®¾ç½®æŒ‡å—](./SHIKI-SETUP.md)
- [Shiki è¯­æ³•å‚è€ƒ](./SHIKI-SYNTAX.md)
- [æ•…éšœæ’é™¤](./SHIKI-TROUBLESHOOTING.md)
- [è¿ç§»æŒ‡å—](./MIGRATION-TO-SHIKI.md)
